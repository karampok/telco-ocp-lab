###PRE lab4
echo '${{ secrets.PULL_SECRET }}' > .pull-secret.json
echo '${{ secrets.ARGO_GIT_KEY }}' > .github-argo
./sinfra --setupInfra -auto-timeout 0s
./sinfra --clean -auto-timeout 0s --continue-on-error
podman logs workstation
podman exec workstation bash -c '
  ./deploy-ocp.sh hub
  export KUBECONFIG=/share/hub/auth/kubeconfig
  openshift-install agent wait-for install-complete --log-level info --dir /share/hub
  oc get co && oc get clusterversion
'
echo "wget http://10.0.0.1:9000/hub/auth/kubeconfig -O ~/.kube/hub.yaml"
echo "curl -s http://10.0.0.1:9000/hub/auth/kubeadmin-\password | xsel --input --clipboard"
podman exec workstation bash -c '
  cd ./hub-config/
  ./install-acm.sh
  sleep 50
'
podman exec workstation bash -c '
  GITKEY_FILE=.github-argo ./hub-config/git-ssh-access.sh || true
  BRANCH=demo PULL_SECRET_PATH=.pull-secret.json ./hub-config/install-ztp.sh
'
echo '${{ secrets.BMH_SECRET }}' > bmh-secret.yaml
podman exec workstation bash -c '
  oc apply -f bmh-secret.yaml
  oc apply -k github.com/karampok/autosecret/config/default
  echo "https://openshift-gitops-server-openshift-gitops.apps.hub.eric.vlab/"
'
podman exec workstation bash -c '
  timeout 1200 ./bin/watch-ztp 5gc || echo ""
  oc -n 5gc wait clusterdeployment 5gc --for=condition=Provisioned --timeout=5400s
'
podman exec workstation bash -c '
  timeout 540 oc -n 5gc get policies -w || echo ""
  oc -n ztp-install wait cgu 5gc --for=condition=Succeeded --timeout=5400s
'

###DEMO STARTS HERE
  oc get policies -A
podman exec workstation bash -c '
  oc extract secret/5gc-admin-kubeconfig --to=- -n 5gc > /tmp/ztp5gc.yaml
  export KUBECONFIG=/tmp/ztp5gc.yaml
  oc get cluster version
  oc get nodes
'

git checkout -b gitops origin/gitops

