---
apiVersion: ran.openshift.io/v1
kind: PolicyGenTemplate
metadata:
  name: "networks"
  namespace: "ztp-group"
spec:
  bindingRules:
    sites: "n95"
  remediationAction: inform
  sourceFiles:
    # NMStates
    - fileName: raw/addRedVRF.yaml
      policyName: "config-red-nmstate-w8"
    - fileName: raw/addGreenStaticRoutes.yaml
      policyName: "config-static-routes"
    # Metallb Instance
    - fileName: metallb/instance.yaml
      policyName: "config-operators-metallb-w10"
      spec:
        logLevel: debug
        speakerTolerations:
          - effect: NoSchedule
            key: sriov
            value: "true"
    # Metallb Config
    - fileName: metallb/bfdProfile.yaml
      policyName: "config-metallb-w12"
    # Green Segment
    - fileName: metallb/bgpPeer.yaml
      policyName: "config-metallb-w12"
      metadata:
        name: green
      spec:
        peerAddress: 11.11.11.254
        peerASN: 8002
        myASN: 7003
        nodeSelectors:
          - matchExpressions:
              - key: kubernetes.io/hostname
                operator: In
                values:
                  - m0.5gc.eric.vlab
                  - m1.5gc.eric.vlab
                  - m2.5gc.eric.vlab
    - fileName: metallb/community.yaml
      policyName: "config-metallb-w12"
      metadata:
        name: green
      spec:
        communities:
          - name: greenc
            value: '7003:008'
    - fileName: metallb/ipAddressPool.yaml
      policyName: "config-metallb-w12"
      metadata:
        name: green
      spec:
        autoAssign: false
        addresses:
          - 5.8.6.1/32
          - 5.8.6.9/32
    - fileName: metallb/bgpAdvertisement.yaml
      policyName: "config-metallb-w12"
      metadata:
        name: green
      spec:
        communities:
          - greenc
        ipAddressPools:
          - green
        peers:
          - green
    # Red Segment
    - fileName: "GenericConfigMap.yaml"
      policyName: "config-bgp-learning-w11"
      metadata:
        name: bgpextras
        namespace: metallb-system
        annotations:
          ran.openshift.io/ztp-deploy-wave: "11"
      data:
        extras: |
          route-map 12.12.12.254-in permit 20
    - fileName: metallb/bgpPeer.yaml
      policyName: "config-metallb-red-w12"
      metadata:
        name: red
      spec:
        peerAddress: 12.12.12.254
        peerASN: 8012
        myASN: 7003
        vrf: red-vrf
        nodeSelectors:
          - matchExpressions:
              - key: kubernetes.io/hostname
                operator: In
                values:
                  - w0.5gc.eric.vlab
    - fileName: metallb/ipAddressPool.yaml
      policyName: "config-metallb-red-w12"
      metadata:
        name: red
      spec:
        autoAssign: false
        addresses:
          - 6.6.6.1/32
          - 6.6.6.9/32
    - fileName: metallb/bgpAdvertisement.yaml
      policyName: "config-metallb-red-w12"
      metadata:
        name: red
      spec:
        ipAddressPools:
          - red
        peers:
          - red
        nodeSelectors:
          - matchLabels:
              node-role.kubernetes.io/ht100gb: ""
              #  egress-service.k8s.ovn.org/metallb-system-exit-node-red: ""
    # - fileName: metallb/EgressService.yaml
    #   policyName: "config-metallb-red-w12"
    #   metadata:
    #     name: exit-node-red
    #     namespace: metallb-system
    #   spec:
    #     sourceIPBy: 'LoadBalancerIP'
    #     nodeSelector:
    #       matchLabels:
    #         node-role.kubernetes.io/ht100gb: ""
    #     network: "2"
